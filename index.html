<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>五大信念猜字謎挑戰</title>
    <style>
        :root { --primary: #003a70; }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 10px; text-align: center; background: #f4f7f9; touch-action: none; overflow-x: hidden; }
        #info-bar { background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #grid-container { 
            display: grid; 
            grid-template-columns: repeat(12, 1fr); 
            gap: 1px; 
            background: #ccc; 
            border: 2px solid var(--primary);
            margin: 0 auto;
            width: 90vw;
            max-width: 480px;
            user-select: none;
        }
        .cell { 
            background: white; 
            aspect-ratio: 1;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 4.5vw; 
        }
        @media (min-width: 480px) { .cell { font-size: 20px; } }
        .selected { background: #ffeb3b !important; }
        .found { background: #4caf50 !important; color: white; }
        #word-list { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 15px; padding: 10px; background: #fff; font-size: 13px; text-align: left; }
        .word-found { text-decoration: line-through; color: #ccc; }
    </style>
</head>
<body>

    <div id="info-bar">
        <strong>尋寶進度: <span id="count">0</span> / 15</strong><br>
        時間: <span id="timer">0</span> 秒
    </div>

    <div id="grid-container"></div>
    <div id="word-list"></div>

    <script>
        // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
        // 【請在這裡貼上你 Apps Script 的網址 (保留雙引號)】
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwmVYMnHqcVf6IA6FK1GDlXLsiSOSYZcqoeMcAx6zBOrN871Bqv3Vhu4H8EW7k9RcuX/exec"; 
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        const words = ["以客為尊", "創新與科技", "卓越服務", "團隊精神", "精益求精", "無微不至", "體貼入微", "推陳出新", "與時俱進", "一絲不苟", "貼心周到", "同舟共濟", "團結一心", "力求完美", "學無止境"];
        
        // 這是你自己設計的矩陣 (共13行，非常好！)
        const gridRows = [
            "以客為尊步步高一絲不苟興",
            "萬事興創意無限好運來喜樂",
            "推陳出新歡天喜地笑口常開",
            "快樂團與時俱進恭喜發財旺",
            "幸福結科鴻運當頭百事可樂",
            "美體一技夢成真團隊精神棒",
            "愛貼心周到處處生機益多福",
            "學入平安喜樂順利力求完美",
            "無微不至錦上添花樂精無憂",
            "止氣東來同舟共濟年年有餘",
            "境隨心轉萬事勝意前程似錦",
            "心想事成福氣滿卓越服務讚",
            "好人一生平安龍馬精神大吉" 
        ];
        // 注意：為了防止錯誤，我加多了一行在最後確保矩陣完整，或者你可以刪除上面最後一行

        let rawString = gridRows.join("");
        const gridArray = rawString.split(""); // 這裡會自動根據文字數量生成
        
        const container = document.getElementById('grid-container');
        const foundWords = new Set();
        let seconds = 0;

        // 生成矩陣
        gridArray.forEach((char, i) => {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.innerText = char;
            cell.setAttribute('data-index', i);
            container.appendChild(cell);
        });

        // 生成清單
        const listContainer = document.getElementById('word-list');
        words.forEach(w => {
            const div = document.createElement('div');
            div.id = 'word-' + w;
            div.innerText = "• " + w;
            listContainer.appendChild(div);
        });

        // 計時器
        let timerRunning = true;
        const timerObj = setInterval(() => {
            if(timerRunning) {
                seconds++;
                document.getElementById('timer').innerText = seconds;
            }
        }, 1000);

        // --- 核心邏輯：鎖定打橫打直 (這部分是你原本缺少的) ---
        let isSelecting = false;
        let startIdx = -1;
        let selectedIndices = [];

        function handleStart(e) {
            isSelecting = true;
            const t = e.touches ? e.touches[0] : e;
            const el = document.elementFromPoint(t.clientX, t.clientY);
            if (el && el.classList.contains('cell')) {
                startIdx = parseInt(el.getAttribute('data-index'));
                selectedIndices = [startIdx];
                el.classList.add('selected');
            }
        }

        function handleMove(e) {
            if (!isSelecting) return;
            const t = e.touches ? e.touches[0] : e;
            const el = document.elementFromPoint(t.clientX, t.clientY);
            
            if (el && el.classList.contains('cell')) {
                const currentIdx = parseInt(el.getAttribute('data-index'));
                
                // 計算座標 (12是原本的寬度)
                const sR = Math.floor(startIdx / 12), sC = startIdx % 12;
                const cR = Math.floor(currentIdx / 12), cC = currentIdx % 12;

                // 重置樣式
                document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected'));
                selectedIndices = [];

                // 判斷方向：只有同一行或同一列才允許畫線
                if (sR === cR) { // 橫向
                    for (let c = Math.min(sC, cC); c <= Math.max(sC, cC); c++) {
                        const idx = sR * 12 + c;
                        selectedIndices.push(idx);
                        container.children[idx].classList.add('selected');
                    }
                } else if (sC === cC) { // 直向
                    for (let r = Math.min(sR, cR); r <= Math.max(sR, cR); r++) {
                        const idx = r * 12 + sC;
                        selectedIndices.push(idx);
                        container.children[idx].classList.add('selected');
                    }
                }
            }
        }

        function handleEnd() {
            if (!isSelecting) return;
            isSelecting = false;
            const str = selectedIndices.map(i => gridArray[i]).join("");
            const rev = str.split("").reverse().join("");
            let f = words.includes(str) ? str : (words.includes(rev) ? rev : "");

            if (f && !foundWords.has(f)) {
                foundWords.add(f);
                selectedIndices.forEach(i => container.children[i].classList.add('found'));
                document.getElementById('word-' + f).className = 'word-found';
                document.getElementById('count').innerText = foundWords.size;
                
                // 檢查是否完成
                if (foundWords.size === words.length) {
                    clearInterval(timerObj);
                    timerRunning = false;
                    
                    // 延遲一點點才彈出輸入框，體驗較好
                    setTimeout(async () => {
                        // 這裡是你原本缺少的部分：輸入資料並上傳
                        if(GOOGLE_SCRIPT_URL.includes("http")) {
                            const userName = prompt("恭喜完成！請輸入您的姓名：");
                            const empId = prompt("請輸入您的員工編號：");
                            
                            if(userName) {
                                alert("正在上傳成績，請稍候...");
                                try {
                                    await fetch(GOOGLE_SCRIPT_URL, {
                                        method: 'POST',
                                        mode: 'no-cors',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            name: userName,
                                            empId: empId,
                                            seconds: seconds
                                        })
                                    });
                                    alert("✅ 成績已成功上傳！感謝參與！");
                                } catch (error) {
                                    alert("⚠️ 上傳失敗，請截圖此畫面給負責人。\n時間: " + seconds + "秒");
                                }
                            }
                        } else {
                            alert("恭喜完成！(尚未設定後台網址)");
                        }
                    }, 500);
                }
            }
            document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected'));
        }

        container.addEventListener('touchstart', handleStart);
        window.addEventListener('touchmove', handleMove, {passive: false});
        window.addEventListener('touchend', handleEnd);
        container.addEventListener('mousedown', handleStart);
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('mouseup', handleEnd);
    </script>
</body>
</html>

